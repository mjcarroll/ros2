name: CI with conda-forge dependencies

on:
  pull_request:

env:
  CACHE_NUMBER: 0

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-2022
            label: win-64
      fail-fast: false

    name: '[${{ matrix.label }}@conda]'
    runs-on: ${{ matrix.os }}
    env:
      # Workspace file to use for the build
      VCS_WORKSPACE_FILE: ros2.repos
      COLCON_BUILD_ARGS: ""
      COLCON_TEST_ARGS: ""

      # Things that control build
      COLCON_DEFAULTS_FILE: ${{ github.workspace }}/.github/ci/colcon_defaults.yaml
    steps:
    - uses: actions/checkout@v2
    - uses: conda-incubator/setup-miniconda@v2
      with:
        mamba-version: "*"
        channels: conda-forge
        channel-priority: true
        activate-environment: ros-ws

    - name: Get Date
      id: get-date
      run: echo "today=$(/bin/date -u '+%Y%m%d')" >> $GITHUB_OUTPUT
      shell: bash

    - name: Cache conda
      uses: actions/cache@v3
      with:
        path: ~/conda_pkgs_dir
        key: ${{ runner.os }}-conda-${{ hashFiles('.github/ci/environment*.yaml') }}-${{ steps.get-date.outputs.today }}-${{ env.CACHE_NUMBER }}
      id: cache

    - name: Conda Export
      run: mamba env export -n ros-ws

    - name: Dependencies
      run: |
        # Workaround for https://github.com/conda-incubator/setup-miniconda/issues/186
        conda config --remove channels defaults
        mamba env update -n ros-ws -f .github/ci/environment.base.yaml
        mamba env update -n ros-ws -f .github/ci/environment.yaml

    - name: Windows-only Dependencies [Windows]
      run: |
        mamba env update -n ros-ws -f .github/ci/environment.win-64.yaml
      if: contains(matrix.os, 'windows') && steps.cache.outputs.cache-hit != 'true'

    - name: Conda Export
      run: mamba env export -n ros-ws

    - name: Checkout Workspace
      shell: bash -l {0}
      run: |
        mkdir -p workspace/src
        echo "::group::vcs import"
        vcs import --input ${{ env.VCS_WORKSPACE_FILE }} --shallow workspace/src
        echo "::endgroup::"

    - name: Build Workspace
      shell: bash -l {0}
      run: |
        cd workspace
        echo "::group::Workspace Branches"
        vcs branch
        echo "::endgroup::"
        colcon build --continue-on-error
